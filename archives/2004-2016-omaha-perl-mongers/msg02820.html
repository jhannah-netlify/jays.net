<!-- MHonArc v2.6.24 -->
<!--X-Subject: Re: [Omaha.pm] My first script -->
<!--X-From-R13: Furbqber Yngfrerf &#60;grqxngNtznvy.pbz> -->
<!--X-Date: 8 Mar 2012 18:46:00 &#45;0000 -->
<!--X-Message-Id: CAJba5eoNBABK6gQCVYWpXkg+dXXEV+Lq7aqvK7XnHV9zWjWs3Q@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: CAF&#45;Fg+gTRVmizx=kmx9FD1ZZ8dzMkNK1PieZDH03Sn7QmuhK3Q@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [Omaha.pm] My first script</title>
<link rev="made" href="mailto:tedkat@gmail.com">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg02819.html">Date Prev</a>][<a href="msg02821.html">Date Next</a>][<a href="msg02819.html">Thread Prev</a>][<a href="msg02821.html">Thread Next</a>][<a href="maillist.html#02820">Date Index</a>][<a href="threads.html#02820">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [Omaha.pm] My first script</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Perl Mongers of Omaha, Nebraska USA&quot; &lt;<a href="mailto:omaha-pm%40pm.org">omaha-pm@pm.org</a>&gt;</li>
<li><em>Subject</em>: Re: [Omaha.pm] My first script</li>
<li><em>From</em>: Theodore Katseres &lt;<a href="mailto:tedkat%40gmail.com">tedkat@gmail.com</a>&gt;</li>
<li><em>Date</em>: Thu, 8 Mar 2012 12:45:57 -0600</li>
<li><em>Delivered-to</em>: <a href="mailto:mailman-omaha-pm%40mailman.pm.dev">mailman-omaha-pm@mailman.pm.dev</a></li>
<li><em>Delivered-to</em>: <a href="mailto:omaha-pm%40pm.org">omaha-pm@pm.org</a></li>
<li><em>Dkim-signature</em>: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113;	h=mime-version:in-reply-to:references:date:message-id:subject:from:to	:content-type; bh=+ePEm2dgWn9tyrPW0XGSZA0FPtjcTuQIf1r4/eQeLS4=;	b=JVdOkaog60OnUiFvcRyiKwiQ9y1+ih576QuCZeKNLYOT8G75h6At40vNeFTXkVKxfL	2yw5NR/ccdN7KKUkXV6LTYMOwF1kMU5pCpXsXxITas+dNdzIgUhIIA5eDWr7gOdilsvY	+u4xJvyJjPIfCAPKmdfKPs/PSsrRGB2VhUHqLoMOSqtq99eBJiaTnEaDKQgyw9yVes21	bhTgwuAdrJ6LPP/N+s0Yfi3AOWSCTyut5nbGM9HlvibcTGDTK/0qUa9wA/YmC3EkRk2c	0U2c/AuJwZFdQcDtSjarN+APjdnPmkK0TnlUPN+pOhNHT9HHV67P3TrxG13ABy10KmQH	iOmQ==</li>
<li><em>In-reply-to</em>: &lt;CAF-Fg+gTRVmizx=kmx9FD1ZZ8dzMkNK1PieZDH03Sn7QmuhK3Q@mail.gmail.com&gt;</li>
<li><em>List-archive</em>: &lt;<a href="http://mail.pm.org/pipermail/omaha-pm">http://mail.pm.org/pipermail/omaha-pm</a>&gt;</li>
<li><em>List-help</em>: &lt;<a href="mailto:omaha-pm-request@pm.org?subject=help">mailto:omaha-pm-request@pm.org?subject=help</a>&gt;</li>
<li><em>List-id</em>: &quot;Perl Mongers of Omaha, Nebraska USA&quot; &lt;omaha-pm.pm.org&gt;</li>
<li><em>List-post</em>: &lt;<a href="mailto:omaha-pm@pm.org">mailto:omaha-pm@pm.org</a>&gt;</li>
<li><em>List-subscribe</em>: &lt;<a href="http://mail.pm.org/mailman/listinfo/omaha-pm">http://mail.pm.org/mailman/listinfo/omaha-pm</a>&gt;,	&lt;<a href="mailto:omaha-pm-request@pm.org?subject=subscribe">mailto:omaha-pm-request@pm.org?subject=subscribe</a>&gt;</li>
<li><em>List-unsubscribe</em>: &lt;<a href="http://mail.pm.org/mailman/options/omaha-pm">http://mail.pm.org/mailman/options/omaha-pm</a>&gt;,	&lt;<a href="mailto:omaha-pm-request@pm.org?subject=unsubscribe">mailto:omaha-pm-request@pm.org?subject=unsubscribe</a>&gt;</li>
<li><em>References</em>: &lt;CAF-Fg+gTRVmizx=kmx9FD1ZZ8dzMkNK1PieZDH03Sn7QmuhK3Q@mail.gmail.com&gt;</li>
<li><em>Reply-to</em>: &quot;Perl Mongers of Omaha, Nebraska USA&quot; &lt;<a href="mailto:omaha-pm%40pm.org">omaha-pm@pm.org</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Just throwing this out there; If you are querying Active Directory you will run into<br>the 1000 results per query limit.&#xA0; Look into using Net::LDAP::Control::Paged<br>to help with this.<br><br>Here is an example<br><br><pre>
sub paged_query
{
    my ( $ldap, $args, $page_size ) = @_;
    my ( @entries, $cookie );

    $page_size = 100 if ( !defined $page_size || $page_size &lt; 1 );
    my $page = Net::LDAP::Control::Paged-&gt;new( size =&gt; $page_size );
    push(@$args, (control =&gt; [$page]));

    my $mesg;

    while ( $mesg = $ldap-&gt;search(@$args) ) {
        last if ( $mesg-&gt;code );
        push(@entries, $e) for my $e ( $mesg-&gt;entries );
        last unless ( my ($resp) = $mesg-&gt;control(LDAP_CONTROL_PAGED) );## list context! `my ($resp)`
        last unless ( $cookie = $resp-&gt;cookie );
        $page-&gt;cookie($cookie);
    }

    warn $mesg-&gt;error if ( $mesg-&gt;code );

    if ($cookie) {
        $page-&gt;cookie($cookie);
        $page-&gt;size(0);
        $ldap-&gt;search(@$args);
        die &#39;LDAP Search error&#39;;
    }
    return ( \@entries );
}</pre><br><div class="gmail_quote">On Thu, Mar 8, 2012 at 12:05 PM, Bill Brush <span dir="ltr">&lt;<a rel="nofollow" href="mailto:bbrush@gmail.com">bbrush@gmail.com</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
Well it&#39;s essentially finished, so I thought I&#39;d share. &#xA0;I&#39;m sure it<br>
could be improved, but honestly I&#39;m just impressed I got it to work.<br>
Now I just need to tweak it to work in unattended cron mode.<br>
<br>
I sanitized the code so none of my particulars are there, for obvious<br>
reasons. &#xA0;Big thanks to Jay for pointing me towards the Email::Stuff<br>
module.<br>
<br>
Bill<br>
<br>
***************************************************************************************************************<br>
<br>
#!/usr/bin/perl<br>
<br>
<br>
use strict;<br>
use Net::LDAP;<br>
use IO::File;<br>
use Email::Stuff;<br>
<br>
#Creates connection to netusrA on the LDAP port, using the ldap_binder account<br>
my $netad = Net::LDAP-&gt;new(&quot;myhost.mydomain&quot;) or die &quot;Could not connect! $!&quot;;<br>
$netad-&gt;bind(&quot;bind account here&quot;, password=&gt;&quot;bind account password here&quot;);<br>
<br>
#Defines the LDAP search to start at the root of the directory tree<br>
my $base = &#39;root of my LDAP directory tree&#39;;<br>
<br>
#The filter is in LDAP format<br>
#The filter specifies users that have an SN (last name) that exists,<br>
but is not equal to System nor starts with Sharepoint<br>
#AND that have an email address<br>
#AND that have a givenname (first name) that is not equal to NET<br>
my $filter = &quot;(&amp;(&amp;(!(sn=System))(!(sn=Sharepoint*))(sn=*))(mail=*)(&amp;(!(givenname=NET))(givenname=*)))&quot;;<br>
<br>
# $attrs specifies which attributes to be retrieved<br>
my $attrs = [&quot;givenname&quot;,&quot;sn&quot;,&quot;mail&quot;];<br>
<br>
# This creates a search result object ($results) from the netad search method<br>
my $results = $netad-&gt;search(base=&gt;$base,filter=&gt;$filter,attrs=&gt;$attrs);<br>
<br>
# This uses the count method of $results to return the number of<br>
records matching the filter<br>
my $count = $results-&gt;count;<br>
<br>
<br>
<br>
#message (&quot;Records returned $count&quot;);<br>
<br>
<br>
<br>
#Creates an output file named emailList.csv or returns error.<br>
my $outputfile = IO::File-&gt;new(&quot;emailList.csv&quot;,&quot;w&quot;) or die &quot;Could not<br>
open output file $!&quot;;<br>
<br>
#Loop to write each result line to the output file<br>
for (my $i=0;$i&lt;$count;$i++){<br>
<br>
 &#xA0; &#xA0; &#xA0; &#xA0;#Assigns the result at $i to the variable $foo<br>
 &#xA0; &#xA0; &#xA0; &#xA0;my $foo = $results-&gt;entry($i);<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;#Assigns the attribute names to variables<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $sn=&quot;sn&quot;;<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $gn=&quot;givenName&quot;;<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $mail=&quot;mail&quot;;<br>
<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;#Assigns the value from $foo to a specific variable<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $lastname = $foo-&gt;get_value($sn);<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $firsttname = $foo-&gt;get_value($gn);<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $email = $foo-&gt;get_value($mail);<br>
<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;#Concatenates the variables to a csv output line. &#xA0;The \n is the new<br>
line operator<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;my $line = &quot;$firsttname,$lastname,$email\n&quot;;<br>
<br>
# &#xA0;Writes the same output to the screen<br>
# &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; message (&quot;$line&quot;);<br>
<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;#Writes the data line to the output file<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;$outputfile-&gt;print($line);<br>
<br>
}<br>
<br>
#Closes the output file<br>
undef $outputfile;<br>
<br>
#Closes the LDAP connection<br>
$netad-&gt;unbind;<br>
<br>
#Email the output file to the SharePoint doc library using the SMTP server<br>
Email::Stuff-&gt;To(&#39;destination e-mail&#39;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;from(&#39;source e-mail&#39;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;Subject(&quot;Automatically generated e-mail list&quot;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;text_body(&quot;E-mail list for Communications department. &#xA0;Used for<br>
Constant Contact service.&quot;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;attach_file(&#39;emailList.csv&#39;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;using(&#39;SMTP&#39;,Host =&gt; &#39;my mail server&#39;)<br>
 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;-&gt;send;<br>
<br>
<br>
sub message<br>
{<br>
 &#xA0; &#xA0;my $m = shift or return;<br>
 &#xA0; &#xA0;print(&quot;$m\n&quot;);<br>
}<br>
_______________________________________________<br>
Omaha-pm mailing list<br>
<a rel="nofollow" href="mailto:Omaha-pm@pm.org">Omaha-pm@pm.org</a><br>
<a rel="nofollow" href="http://mail.pm.org/mailman/listinfo/omaha-pm" target="_blank">http://mail.pm.org/mailman/listinfo/omaha-pm</a><br>
</blockquote></div><br><br clear="all"><br>-- <br>Ted Katseres<br>&#xA0; &#xA0; &#xA0; ||=O=||<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="02819" href="msg02819.html">[Omaha.pm] My first script</a></strong>
<ul><li><em>From:</em> Bill Brush &lt;bbrush@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg02819.html">[Omaha.pm] My first script</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg02821.html">Re: [Omaha.pm] My first script</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg02819.html">[Omaha.pm] My first script</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg02821.html">Re: [Omaha.pm] My first script</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#02820"><strong>Date</strong></a></li>
<li><a href="threads.html#02820"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
